name: Deploy ICP Canister

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  DFX_VERSION: "0.28.0"
  RUST_VERSION: "1.89.0"

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./merodocs_registry

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ./merodocs_registry/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y bc
          cargo install --force candid-extractor --version 0.1.4
          DFXVM_INIT_YES=true DFX_VERSION=${{ env.DFX_VERSION }} sh -c "$(curl -fsSL https://internetcomputer.org/install.sh)"
          echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH

      - name: Verify DFX installation
        run: |
          source "$HOME/.local/share/dfx/env"
          dfx --version

      - name: Setup dfx identity
        run: |
          source "$HOME/.local/share/dfx/env"
          echo "${{ secrets.DFX_IDENTITY_PEM }}" > identity.pem
          # Remove deployment identity if it exists
          dfx identity remove deployment 2>/dev/null || true
          # Import the deployment identity without encryption
          dfx identity import deployment identity.pem --disable-encryption
          dfx identity use deployment
          rm identity.pem
          # Set environment variable to suppress mainnet plaintext identity warning
          echo "DFX_WARNING=-mainnet_plaintext_identity" >> $GITHUB_ENV

      - name: Build canister
        run: |
          source "$HOME/.local/share/dfx/env"
          dfx build
          cargo build --target wasm32-unknown-unknown --release -p backend
          candid-extractor target/wasm32-unknown-unknown/release/backend.wasm > backend/backend.did

      - name: Deploy canister
        run: |
          source "$HOME/.local/share/dfx/env"
          CYCLES=$(echo "1.0 * 1000000000000" | bc -l | cut -d. -f1)
          dfx deploy --network ic --with-cycles $CYCLES

      - name: Get canister info
        run: |
          source "$HOME/.local/share/dfx/env"
          CANISTER_ID=$(dfx canister --network ic id backend)
          echo "**Canister ID**: $CANISTER_ID" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://${CANISTER_ID}.icp0.io" >> $GITHUB_STEP_SUMMARY
